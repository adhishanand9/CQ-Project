<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>CQ</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        *{
            box-sizing: border-box;
        }
        body {
			margin: 0;
            padding: 0;
            width: 100%;
            background: #f5f5f5;
            font-family: 'Roboto', sans-serif;
		}
		nav {
            position:fixed;
            width:100%;
            height: 60px;
			background-color: #222D3C;
            color: #fff;
            z-index: 9999999;
		}
		nav p {
            margin: 0;
            float: left;
            height: 50px;
            padding: 15px 15px;
            font-size: 20px;
            line-height: 20px;
            font-weight: bold;
		}
		nav span {
            float: right;
            padding: .2em .6em .3em;
            margin-top: 22px;
            margin-left: 5px;
            font-size: 75%;
            line-height: 1;
            font-weight: 700;
            color: #fff;
            font-size: 14px;
            vertical-align: center;
            border-radius: .25em;
            vertical-align: baseline;
		}
		nav img {
			float: right;
			border-radius: 50%;
			padding: 15px;
        }
		#menu {
            position:fixed;
            padding-top: 60px;
            background-color: #000;
            width: 50px;
            height:100vh;
            color:white;
            box-sizing: border-box;
            overflow:hidden;
            z-index: 99;
		}
		.fa {
            color: #fff;
			font-size: 25px;
			width: 30px;
			margin: 6px 15px;
			margin-left: 11px;
			box-sizing: border-box;
		}
		.menu-item {
            width: 250px;
			cursor: pointer;
			opacity: 0.8;
			color: #fff;
			font-family: sans-serif;
			font-size: 14px;
            padding-top: 10px;
		}
		.menu-item:hover {
			border-left: 2px solid red;
			opacity: 1;
			background-color: #4d5866;
		}
        .active{
            background: #51a1e2 !important;
        }
        #user_icon{
            height:100%;
            width: 10%;
        }
        #community_header_div{
            position: absolute;
            top:60px;
            width: 100%;
            padding-left: 100px;
            background-color: #3ea7c1;
            line-height: 50px;
        }

        #body_internal_div{
            padding:0;
            margin:0;
            position: absolute;
            left: 18%;
            top: 15%;
            width: 60%;
            padding-bottom: 10%;
            box-sizing: border-box;
            /* height: 550px; */
        }
        #community_header_div button i {
            padding: 0;
            margin: 5px;
            display: block;
        }
        #body_internal_header_div{
            background-color: #3ea7c1;
            line-height: 50px;
            font-size: 16px;
            color: #fff;
            padding-left: 20px;
        }

        #profile_button{
            cursor: pointer;
            padding: 0;
            padding-left: 5px;
            padding-top: 5px;
            height: 60px;

        }
        #body-contents-community{
          margin:5px;
          border: 2px solid #eeeeee;
          background-color:#FFFFFF;
          padding:5px;
        }
        #join-button{

        }

        #community_list_icon{
          float:left;
        }
        #search_input {
          background-repeat: no-repeat;
          width: 40%;
          float:right;
          margin:5px;
          font-size: 16px;
          padding: 12px 20px 12px 40px;
          border: 1px solid #ddd;
          margin-bottom: 12px;
          height:40px;
}
#border1
{
    padding-top: 60px;
    position: static;
    text-align: center;
    background-color: #3ea7c1;
    overflow: auto;
    transition: .3s ease;
}


#myCommList
{
    background-color: cornflowerblue;
}

#communityBar
{
    height: 53px;
    background-color: #3ea7c1;
}

#reload
{
  background: transparent;
  border: 1px solid #fff;
  width: 50px;
  color: #fff;
  cursor: pointer;
  margin-top: 5px;
  margin-left: 3.5%;
  float:left;
}

#searchCommunity
{
  background: transparent;
  border: 1px solid #fff;
  width: 50px;
  color: #fff;
  cursor: pointer;
  margin-left: 10px;
  margin-top: 5px;
  float: left;
}

.communityDiv
{
    width: 80%;
    margin-top: 20px;
    background-color: white;
    display: inline-table;
    height: 135px;
    box-shadow: 0 3px 10px 0 rgba(147, 176, 180, 0.55);
    box-sizing: border-box;
    border-radius: 5px;
}

.communityDivImage
{
    height: 80px;
    width: 80px;
    float: left;
    margin-left: 20px;
    margin-top: 10px;
    border: 2px solid #212121;
}

.communityDivButton
{
    margin-right: 15px;
    margin-top: 50px;
    float: right;
    width:70px;
    height: 40px;
    color: white;
    background-color: #337ab7;
    border: 1px solid #212121;
}

.communityDivLabel
{
    padding-left: 20px;
    text-align: left;
    float: left;
    width: 100%;
    color: #337ab7;
}
.communityDivLabel2
{
    padding-left: 20px;
    text-align: left;
    float: left;
    width: 100%;
}
    </style>
</head>
<body>
    <% include partials/menu.html %>
    <div id="border1" style="padding-left: 50px;">
    <div id="communityBar">
        <button id="reload">
            <i class="fa fa-group"
               style="transform: translateX(-10%)"></i>
        </button>
        <button id="searchCommunity">
            <i class="fa fa-search"
               style="transform: translateX(-10%)"></i>
        </button>

    </div>
    <div id="body_internal_div">
    </div>
  </body>
  <script>
  console.log('<%= data[0].role%>');
  var menu = document.getElementById("menu");
  var sideBtn = document.getElementById("sideBtn");
  var body_internal_div = document.getElementById("body_internal_div");
  var span = menu.getElementsByTagName("span");
  var communtiydata = <%-JSON.stringify(communtiydata)%>;

  var div = menu.getElementsByTagName('div');
  for(var i=0;i<div.length;i++){
      div[i].classList.remove("active");
  }
  var create=document.getElementById("createCommunity");
  div[2].classList.add("active");

  $(document).ready(function(){
    $("#sideBtn").click(function(){
       if($("#menu").width() == 50){
          $("#menu").animate({width: '250px'},300);
          $("#body_internal_div").animate({left:'30%'},300);
       } else{
          $("#menu").animate({width: '50px'},300);
          $("#body_internal_div").animate({left:'18%'},300);
       }
    });
 });
 document.getElementById('reload').onclick = function ()
 {
     window.location.replace('/communtiy/communitypanel');
 };

 document.getElementById('searchCommunity').onclick = function ()
 {
     window.location.replace('/communtiy/communitypanellist');
 };

 let list = document.getElementById("body_internal_div");
 let flag = false;
 let skip = 0;
 let requestFlag = false;
 function loadCommunities()
 {
     if(requestFlag === true)
         return;
     requestFlag = true;
     let request = new XMLHttpRequest();
     request.addEventListener('load', function ()
     {
         if(request.responseText === 'ERROR')
         {
             alert('ERROR');
             requestFlag = false;
         }
         else if(request.responseText === 'DONE')
         {
             flag = true;
         }
         else
         {
            //  console.log(request.responseText);
             let communities = JSON.parse(request.responseText);
             console.log(communities);
             communities.forEach(function(community)
             {
                 let div1 = document.createElement('div');
                 div1.className = "communityDiv";

                 let div2 = document.createElement('div');
                 div2.style.height = '100px';

                 let img = document.createElement('img');
                 img.src = '/'+community.image;
                 img.className = "communityDivImage";
                 div2.appendChild(img);

                 let button = document.createElement('button');
                 button.className = "communityDivButton";
                 if(community.membershiprule === 'permission')
                 {
                     button.innerHTML = 'Ask to join';
                     button.onclick = function ()
                     {
                         let request = new XMLHttpRequest();
                         request.addEventListener('load', function()
                         {
                             if(request.responseText === 'DONE')
                                 list.removeChild(div1);
                         });
                         request.open('POST', '/addRequest');
                         request.setRequestHeader('Content-type', 'application/json');
                         request.send(JSON.stringify({communityId: community._id}));
                     }
                 }
                 else
                 {
                     button.innerHTML = 'Join';
                     button.onclick = function ()
                     {
                         let request = new XMLHttpRequest();
                         request.addEventListener('load', function()
                         {
                             if(request.responseText === 'DONE')
                                 list.removeChild(div1);
                         });
                         request.open('POST', '/addCommunityUser');
                         request.setRequestHeader('Content-type', 'application/json');
                         request.send(JSON.stringify({communityId: community._id}));
                     }
                 }
                 div2.appendChild(button);
                 div1.appendChild(div2);

                 let label1 = document.createElement('label');
                 label1.className = "communityDivLabel";
                 label1.style.fontSize = '18px';
                 label1.innerHTML = community.comname;
                 div1.appendChild(label1);

                 let label2 = document.createElement('label');
                 label2.className = "communityDivLabel2";
                 label2.innerHTML = community.communitydescription;
                 div1.appendChild(label2);
                 list.appendChild(div1);
             });
             skip += 7;
             requestFlag = false;
         }
     });
     request.open('POST', '/getSearchCommunities');
     request.setRequestHeader('Content-type', 'application/json');
     request.send(JSON.stringify({skip: skip}));
 }

 loadCommunities();

 window.onscroll =  function()
 {
     if (flag === false && window.pageYOffset + window.innerHeight > list.offsetHeight)
     {
         loadCommunities();
     }
 };
  </script>
</html>
